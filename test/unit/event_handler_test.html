<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>JavaScript unit test file</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />  
  <script src="../assets/prototype.js" type="text/javascript"></script>
  <script src="../assets/unittest.js" type="text/javascript"></script>
  
  <script src="../../src/event_handler.js" type="text/javascript"></script>
  <link rel="stylesheet" href="../assets/unittest.css" type="text/css" />
  
</head>
<body class="mbx">

<div id="content">

  <div id="header">
    <h1>JavaScript unit test file</h1>
    <p>
      This file tests <strong>event_handler.js</strong>.
    </p>
  </div>
  
  <div id="event_receiver" class="receiver_class"></div>
  
  <div id="array_checker_one"></div>
  <div id="array_checker_two"></div>

  <!-- Log output -->
  <div id="testlog"> </div>

</div>

<script type="text/javascript">
// <![CDATA[

  checker = {};
  MBX.cssNamespace = ".mbx";
  
  MBX.EventHandler.subscribe("#event_receiver", "customEvent", function(evt) {
    checker.IDBasedCustomEvent = evt;
  });
  MBX.EventHandler.subscribe(MBX.cssNamespace, "customEvent", function(evt) {
    checker.IDBasedCustomEventBubblesToBody = evt;
  });
  MBX.EventHandler.subscribe(".receiver_class", "click", function(evt) {
    checker.classBasedBrowserEvent = evt;
  });
  MBX.EventHandler.subscribe(MBX.cssNamespace, "click", function(evt) {
    checker.BrowserEventBubblesToBody = evt;
  });
  
  clickEventReceiver = function(el) {
    el = el || $("event_receiver");
    if(el.click) {
      el.click();
    } else {
      var evt = document.createEvent("MouseEvents");
      evt.initEvent("click", true, true);
      el.dispatchEvent(evt);
    }
  };
  
  var calledCounter = 0;
  
  var incCalledCounter = function() {
    calledCounter += 1;
  }

  new Test.Unit.Runner({
    
    // replace this with your real tests
    
    setup: function() {
      MBX.EventHandler.fireCustom($("event_receiver"), "customEvent");
    },
    
    teardown: function() {
      checker = {};
      calledCounter = 0;
    },
    
    testCustomEventFires: function() { with(this) {
      assert(checker);
      assert(checker.IDBasedCustomEvent);
    }},
    
    testCustomEventBubblesToBody: function() { with(this) {
       assert(checker.IDBasedCustomEventBubblesToBody);
    }},
    
    testCustomEventGetExtended: function() { with(this) {
       var theEvent;
       
       var handler = function (evt) {
         theEvent = evt;
       }
       
       MBX.EventHandler.subscribe("#array_checker_one", "extendFire", handler);
       MBX.EventHandler.fireCustom($('array_checker_one'), "extendFire");
       assertEqual("function", typeof theEvent.element);
       assertEqual($('array_checker_one'), theEvent.element());
    }},
    
    testBrowserEventsAreCaptured: function() { with(this) {
       clickEventReceiver();
       assert(checker.classBasedBrowserEvent);
    }},
    
    testBrowserEventsBubbleToBody: function() { with(this) {
       clickEventReceiver();
       assert(checker.BrowserEventBubblesToBody);
    }},
    
    testSubscriptionTakesAnArray: function() { with(this) {
       MBX.EventHandler.subscribe(["#array_checker_one", "#array_checker_two"], "arrayFire", incCalledCounter);
       MBX.EventHandler.fireCustom($("array_checker_one"), "arrayFire");
       assertEqual(1, calledCounter);
       MBX.EventHandler.fireCustom($("array_checker_two"), "arrayFire");
       assertEqual(2, calledCounter);
    }},
    testUnsubscribes: function() { with(this) {
      var hndlerObj = MBX.EventHandler.subscribe("#array_checker_one", "unsubscribe_test", incCalledCounter);
      MBX.EventHandler.fireCustom($("array_checker_one"), "unsubscribe_test");
      assertEqual(1, calledCounter);
      MBX.EventHandler.unsubscribe(hndlerObj);
      MBX.EventHandler.fireCustom($("array_checker_one"), "unsubscribe_test");
      assertEqual(1, calledCounter);
    }}
      
  }, "testlog");
// ]]>
</script>
</body>
</html>
